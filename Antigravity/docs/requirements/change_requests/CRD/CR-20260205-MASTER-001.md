# Change Request: Employee & Master Data Module - Complete Implementation

**CR ID**: CR-20260205-MASTER-001  
**Ng√†y t·∫°o**: 2026-02-05  
**Ng∆∞·ªùi t·∫°o**: Antigravity - Design Authority  
**ƒê·ªô ∆∞u ti√™n**: üî¥ CRITICAL  
**Lo·∫°i CR**: FEATURE_COMPLETION + BUG_FIX + TECHNICAL_DEBT + ARCHITECTURE_IMPROVEMENT  
**Tr·∫°ng th√°i**: DRAFT  
**Estimated Effort**: 3 weeks (17 developer-days / 136 hours)

---

## üìã Executive Summary

### M·ª•c ti√™u
Ho√†n thi·ªán **to√†n b·ªô Employee & Master Data module** v·ªõi architecture improvements v√† best practices:

1. ‚úÖ T·∫°o UI pages qu·∫£n l√Ω cho **Departments, Positions, Levels**
2. ‚úÖ T·∫°o **5 SmartSelect search endpoints** (departments, positions, levels, employees, users)
3. ‚úÖ Fix **schema mismatch** gi·ªØa UI v√† Database cho Employee
4. ‚úÖ Remove **mock data** trong EmployeeManagement v√† WarehouseManagement
5. ‚úÖ Implement **Employee-User linking** v·ªõi best practices
6. ‚úÖ Resolve **Department/Role/Email conflicts**
7. ‚úÖ Add **validation rules** v√† **sync mechanisms**
8. ‚úÖ Implement **lifecycle management** v·ªõi automated warnings
9. ‚úÖ ƒê·∫£m b·∫£o **scalability** v√† **data integrity**

### Business Impact

| Impact Area | Current State | After CR | Severity |
|-------------|---------------|----------|----------|
| **Functional Completeness** | Admin kh√¥ng th·ªÉ qu·∫£n l√Ω departments/positions/levels | Full CRUD UI available | üî¥ CRITICAL |
| **Data Integrity** | Employee creation fails, mock data IDs, department conflicts | Schema aligned, real data, validation enforced | üî¥ CRITICAL |
| **User Management** | Cannot link Employee‚ÜîUser, no lifecycle management | Full linking + automated warnings | üî¥ HIGH |
| **Security** | Terminated employees' users still active | Automated deactivation workflow | üî¥ HIGH |
| **UX Consistency** | Mock data, inconsistent patterns | Real data, SmartSelect everywhere | üü° MEDIUM |
| **Compliance** | Violates FRD FR-MD-005-02 | FRD compliant | üî¥ HIGH |

---

## üö® V·∫§N ƒê·ªÄ PH√ÅT HI·ªÜN (6 GAPS)

### GAP #1: Thi·∫øu UI Pages cho Master Tables
**Severity**: üî¥ CRITICAL  
**FRD Violation**: FR-MD-005-02

| Entity | API Route | UI Page | Component | Status |
|--------|-----------|---------|-----------|--------|
| Departments | ‚úÖ `/api/master/departments` | ‚ùå MISSING | ‚ùå MISSING | **BLOCKED** |
| Positions | ‚úÖ `/api/master/positions` | ‚ùå MISSING | ‚ùå MISSING | **BLOCKED** |
| Levels | ‚úÖ `/api/master/levels` | ‚ùå MISSING | ‚ùå MISSING | **BLOCKED** |

**Impact**:
- Admin **KH√îNG TH·ªÇ** qu·∫£n l√Ω departments/positions/levels qua UI
- Ph·∫£i d√πng database tools ƒë·ªÉ th√™m/s·ª≠a/x√≥a master data
- Kh√¥ng c√≥ validation, audit logs cho master data changes
- Violates FRD requirement **FR-MD-005-02**: "Manage Structure - Manage Key Lists: Departments, Positions, Levels"

**Evidence**:
- ‚úÖ API routes exist: `app/api/master/departments/route.ts`, `app/api/master/positions/route.ts`, `app/api/master/levels/route.ts`
- ‚ùå UI pages missing: `app/(main)/master-data/` kh√¥ng c√≥ `departments`, `positions`, `levels` folders
- ‚ùå Components missing: `components/master/` kh√¥ng c√≥ `DepartmentManagement.tsx`, `PositionManagement.tsx`, `LevelManagement.tsx`

---

### GAP #2: Thi·∫øu SmartSelect Search Endpoints
**Severity**: üî¥ HIGH

| Entity | Endpoint | Status | Required By |
|--------|----------|--------|-------------|
| Departments | `/api/shared/search/departments` | ‚ùå MISSING | EmployeeManagement, UserForm |
| Positions | `/api/shared/search/positions` | ‚ùå MISSING | EmployeeManagement |
| Levels | `/api/shared/search/employee-levels` | ‚ùå MISSING | EmployeeManagement |
| Employees | `/api/shared/search/employees` | ‚ùå MISSING | WarehouseManagement, Future modules |
| Users | `/api/shared/search/users` | ‚ùå MISSING | Employee linking |

**Impact**:
- EmployeeManagement component **ƒê√É MIGRATE** sang SmartSelect nh∆∞ng **KH√îNG HO·∫†T ƒê·ªòNG**
- SmartSelect calls return **404 errors**
- Filters v·∫´n d√πng **hardcoded mock data**
- Kh√¥ng c√≥ advanced search (multi-field, pagination, context filtering)

**Evidence t·ª´ EmployeeManagement.tsx** (lines 108-139):
```typescript
const departmentDataSource: SelectDataSource = {
  search: async (req) => {
    const res = await fetch('/api/shared/search/departments', { // ‚ùå 404
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(req)
    });
    return res.json();
  }
};
```

---

### GAP #3: Schema Mismatch - Employee Fields
**Severity**: üî¥ HIGH

**Database Schema** (Prisma):
```prisma
model employees {
  full_name String  // ‚úÖ REQUIRED - Single field
}
```

**UI Component** (`EmployeeManagement.tsx`):
```typescript
interface Employee {
  first_name: string;   // ‚ùå NOT IN DB
  last_name: string;    // ‚ùå NOT IN DB
}
```

**Impact**:
- Create employee s·∫Ω **FAIL** v√¨ API expects `full_name` nh∆∞ng UI sends `first_name` + `last_name`
- Validation error: "full_name is required" (line 58-62 trong `app/api/master/employees/route.ts`)
- User confusion: Form c√≥ 2 fields nh∆∞ng DB ch·ªâ l∆∞u 1 field

---

### GAP #4: Mock Data trong Components
**Severity**: üü° MEDIUM (HIGH for data integrity)

#### Component #1: EmployeeManagement.tsx
**Location**: Lines 73-99  
**Mock Arrays**: 3 (departments, positions, levels)

```typescript
const departments = [
  { id: "1", name: "Sales" },
  { id: "2", name: "Service" },
  // ... 6 items
]

const positions = [
  { id: "1", name: "Staff" },
  // ... 6 items
]

const levels = [
  { id: "1", name: "Level 1" },
  // ... 6 items
]
```

**Impact**:
- Filter dropdowns show **fake data**, kh√¥ng match v·ªõi database
- User kh√¥ng th·ªÉ filter by real departments/positions/levels
- Inconsistent v·ªõi c√°c modules kh√°c ƒë√£ migrate

#### Component #2: WarehouseManagement.tsx
**Location**: Lines 56-63  
**Mock Arrays**: 1 (managers)

```typescript
const managers = [
  { id: "1", name: "Nguy·ªÖn VƒÉn A" },
  { id: "2", name: "Tr·∫ßn Th·ªã B" },
  // ... 6 items
]
```

**Impact** (üî¥ DATA INTEGRITY ISSUE):
- Warehouse `manager_id` l∆∞u v√†o DB l√† **"1", "2", "3"...** (fake IDs)
- **KH√îNG LINK** v·ªõi real employees trong database
- Khi query warehouse, `manager_name` s·∫Ω null ho·∫∑c sai
- Foreign key constraint violation risk
- Cannot track warehouse manager changes

---

### GAP #5: Thi·∫øu User Linking trong EmployeeManagement
**Severity**: üü° MEDIUM

**Evidence**:
```typescript
// EmployeeManagement.tsx - KH√îNG C√ì user_id field
interface EmployeeFormData {
  // ‚ùå MISSING: user_id field
  // ‚ùå MISSING: "Create User Account" button
}
```

**Impact**:
- Admin **KH√îNG TH·ªÇ** link employee v·ªõi user account qua UI
- Ph·∫£i manual update database ƒë·ªÉ set `user_id`
- Kh√¥ng c√≥ dropdown ƒë·ªÉ select existing users
- Kh√¥ng c√≥ validation ƒë·ªÉ prevent duplicate user linking

---

### GAP #6: Department/Role/Email Conflicts
**Severity**: üî¥ HIGH

#### Conflict #1: User.department vs Employee.department_id
```prisma
model User {
  department String?  // ‚ùå String - kh√¥ng chu·∫©n h√≥a
}
model employees {
  department_id String?  // ‚úÖ FK to master_departments
}
```
**Problem**: Data duplication v√† conflict khi link User‚ÜîEmployee

#### Conflict #2: Dual Role System
```prisma
model User {
  role    String   // ‚ùå Hardcoded string
  role_id String?  // ‚úÖ FK to Role table
}
```
**Problem**: Kh√¥ng r√µ source of truth, risk inconsistency

#### Conflict #3: Email Missing in Employee
```prisma
model employees {
  // ‚ùå KH√îNG C√ì email field
}
```
**Problem**: Kh√¥ng th·ªÉ t·∫°o User account cho Employee, incomplete profile

---

## üéØ BEST PRACTICE SOLUTIONS

### Solution #1: Department Management - Computed Field

**Approach**: User.department = computed field t·ª´ Employee.department_id

**Implementation**:
```typescript
// API Response - Computed field
GET /api/users/:id
{
  id: "user_001",
  email: "john@honda.com",
  role: "SALES_STAFF",
  // Computed t·ª´ Employee relation
  department: employee?.master_departments?.department_name || null,
  department_id: employee?.department_id || null
}
```

**Migration Steps**:
1. Add computed field trong User API responses
2. Deprecate User.department column (set nullable)
3. Update all User API endpoints
4. Documentation

**Benefits**:
- ‚úÖ Single source of truth (master_departments)
- ‚úÖ Automatic sync (real-time t·ª´ Employee)
- ‚úÖ No data duplication
- ‚úÖ Backward compatible

---

### Solution #2: Role Assignment - Manual with Smart Defaults

**Approach**: Admin manually ch·ªçn role, system g·ª£i √Ω d·ª±a tr√™n position

**UI Flow**:
```typescript
// "Create User Account" dialog
<Dialog>
  <Alert type="info">
    Suggested roles for "{employee.position_name}":
    <Badge>SALES_MANAGER</Badge> <Badge>SALES_STAFF</Badge>
  </Alert>
  
  <SmartSelect
    label="Role *"
    dataSource={roleDataSource}
    context={{ suggestedFirst: true, employeeId: employee.id }}
    required
  />
</Dialog>
```

**Position-Role Mapping** (config):
```typescript
const POSITION_ROLE_MAPPING = {
  "Sales Manager": ["SALES_MANAGER", "SALES_STAFF"],
  "Service Advisor": ["SERVICE_ADVISOR", "SERVICE_STAFF"],
  "Technician": ["TECHNICIAN"],
  "Admin Staff": ["ADMIN"]
};
```

**Benefits**:
- ‚úÖ Explicit, no magic
- ‚úÖ Flexible - Admin c√≥ final decision
- ‚úÖ Smart suggestions gi√∫p nhanh h∆°n
- ‚úÖ No schema changes

---

### Solution #3: Lifecycle Management - Automated Warning System

**Approach**: Event-driven notifications + manual decision

**Event Handler**:
```typescript
async function onEmployeeStatusChange(employeeId: string, newStatus: string) {
  if (newStatus === "TERMINATED") {
    const employee = await prisma.employees.findUnique({
      where: { id: employeeId },
      include: { User: true }
    });
    
    if (employee.User) {
      // Create notification
      await prisma.notifications.create({
        data: {
          type: "EMPLOYEE_TERMINATED_WITH_USER",
          title: `Employee ${employee.full_name} terminated`,
          message: `User account ${employee.User.email} is still ACTIVE`,
          action_url: `/admin/users/${employee.User.id}`,
          severity: "WARNING",
          target_user_roles: ["ADMIN", "HR_MANAGER"]
        }
      });
      
      // Schedule auto-deactivate after 7 days
      await prisma.scheduled_tasks.create({
        data: {
          task_type: "DEACTIVATE_USER",
          target_id: employee.User.id,
          scheduled_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
          status: "PENDING",
          can_cancel: true
        }
      });
    }
  }
}
```

**Admin Dashboard Widget**:
```typescript
<Card>
  <CardTitle>‚ö†Ô∏è Terminated Employees with Active Users (3)</CardTitle>
  <Table>
    <Row>
      <Cell>John Doe</Cell>
      <Cell>john@honda.com</Cell>
      <Cell>Terminated: 2026-02-01</Cell>
      <Cell>User: ACTIVE</Cell>
      <Cell>
        <Button onClick={deactivateUser}>Deactivate User</Button>
        <Button variant="outline">Keep Active</Button>
      </Cell>
    </Row>
  </Table>
</Card>
```

**Benefits**:
- ‚úÖ Security - kh√¥ng qu√™n deactivate users
- ‚úÖ Flexibility - Admin c√≥ final decision
- ‚úÖ Grace period - 7 days ƒë·ªÉ review
- ‚úÖ Audit trail ƒë·∫ßy ƒë·ªß

---

### Solution #4: Scalability - Keep 1-to-1 with Future-proof Design

**Current Implementation**:
```prisma
model User {
  employees  employees?  // 1-to-1
}

model employees {
  user_id  String?  @unique  // 1-to-1
}
```

**Rationale**:
- 99% use case: 1 person = 1 employee record
- Simple logic, easier to maintain
- YAGNI principle (You Aren't Gonna Need It)

**Future Migration Path** (if needed):
```prisma
// Phase 2 - Many-to-Many
model EmployeeUserAssignment {
  id          String   @id
  user_id     String
  employee_id String
  is_primary  Boolean  @default(false)
  
  User      User      @relation(fields: [user_id], references: [id])
  Employee  employees @relation(fields: [employee_id], references: [id])
  
  @@unique([user_id, employee_id])
}
```

**Benefits**:
- ‚úÖ Simple now
- ‚úÖ Can scale later
- ‚úÖ Clear migration path

---

### Solution #5: Email Field - Add Optional Email to Employee

**Schema Change**:
```prisma
model employees {
  id         String   @id
  full_name  String
  email      String?  // ‚úÖ NEW - Optional, not unique
  phone      String?
  user_id    String?  @unique
}
```

**Business Rules**:
```typescript
// Rule 1: Employee.email is OPTIONAL
// - Drivers, cleaners kh√¥ng c·∫ßn email
// - Sales, managers c·∫ßn email

// Rule 2: Employee.email KH√îNG UNIQUE
// - Nhi·ªÅu employees c√≥ th·ªÉ share: info@honda.com
// - Ch·ªâ User.email m·ªõi unique

// Rule 3: Khi t·∫°o User cho Employee
async function createUserForEmployee(employeeId: string, userData: CreateUserDto) {
  const employee = await prisma.employees.findUnique({ where: { id: employeeId } });
  
  const email = userData.email || employee.email;
  
  if (!email) {
    throw new Error("Email is required to create user account");
  }
  
  // Check User.email uniqueness
  const existingUser = await prisma.User.findUnique({ where: { email } });
  if (existingUser) {
    throw new Error(`Email ${email} already used by another user`);
  }
  
  // Create User
  const user = await prisma.User.create({
    data: {
      email,
      password_hash: hashPassword(userData.password),
      role_id: userData.role_id,
      name: employee.full_name,
      employees: { connect: { id: employeeId } }
    }
  });
  
  // Sync email back to Employee if needed
  if (!employee.email) {
    await prisma.employees.update({
      where: { id: employeeId },
      data: { email }
    });
  }
  
  return user;
}
```

**Migration Script**:
```typescript
// Migrate existing employees
async function migrateEmployeeEmails() {
  const employeesWithUsers = await prisma.employees.findMany({
    where: { user_id: { not: null } },
    include: { User: true }
  });
  
  for (const emp of employeesWithUsers) {
    if (!emp.email && emp.User?.email) {
      await prisma.employees.update({
        where: { id: emp.id },
        data: { email: emp.User.email }
      });
    }
  }
}
```

**Benefits**:
- ‚úÖ Complete employee profile
- ‚úÖ Can create User without asking email again
- ‚úÖ Flexible (optional)
- ‚úÖ No conflict with User.email

---

## üìù DETAILED REQUIREMENTS

### Requirement #1: Department Management UI

**Page**: `app/(main)/master-data/departments/page.tsx`  
**Component**: `components/master/DepartmentManagement.tsx`

**Features**:
- ‚úÖ List departments v·ªõi pagination
- ‚úÖ Search by department_name, department_code
- ‚úÖ Create new department
- ‚úÖ Edit existing department
- ‚úÖ Soft delete department (set status = INACTIVE)
- ‚úÖ Filter by status (ACTIVE/INACTIVE)

**Form Fields**:
```typescript
interface DepartmentFormData {
  department_code: string;  // Auto-generated (DEPT-XXX)
  department_name: string;  // Required, max 200 chars
  description?: string;     // Optional
  status: 'ACTIVE' | 'INACTIVE';  // Default ACTIVE
}
```

**Table Columns**:
- Department Code
- Department Name
- Description
- Status (Badge)
- Employee Count (computed)
- Actions (Edit, Delete)

**Validation**:
- Department code: Auto-generated, format `DEPT-XXX`
- Department name: Required, max 200 chars, unique
- Status: Enum (ACTIVE/INACTIVE)

---

### Requirement #2: Position Management UI

**Page**: `app/(main)/master-data/positions/page.tsx`  
**Component**: `components/master/PositionManagement.tsx`

**Features**: Same as Department Management

**Form Fields**:
```typescript
interface PositionFormData {
  position_code: string;  // Auto-generated (POS-XXX)
  position_name: string;  // Required, max 200 chars
  description?: string;   // Optional
  status: 'ACTIVE' | 'INACTIVE';
}
```

---

### Requirement #3: Level Management UI

**Page**: `app/(main)/master-data/levels/page.tsx`  
**Component**: `components/master/LevelManagement.tsx`

**Features**: Same as Department Management

**Form Fields**:
```typescript
interface LevelFormData {
  level_code: string;  // Auto-generated (LVL-XXX)
  level_name: string;  // Required, max 200 chars
  description?: string;
  status: 'ACTIVE' | 'INACTIVE';
}
```

---

### Requirement #4: Employee-User Linking Feature

**Goal**: Cho ph√©p Admin link employee v·ªõi user account

**UI Changes**:

1. **Add User Selection Field** trong Employee Form:
```typescript
<div className="col-span-2">
  <Label htmlFor="user_id">User Account (Optional)</Label>
  <SmartSelect
    dataSource={userDataSource}
    value={formData.user_id ? Number(formData.user_id) : null}
    onChange={(id) => setFormData({ ...formData, user_id: id ? String(id) : null })}
    placeholder="Select user account..."
    required={false}
    allowClear={true}
    context={{ onlyActive: true, excludeLinkedUsers: true }}
  />
  <p className="text-sm text-gray-500 mt-1">
    Link this employee to a user account for system login
  </p>
</div>
```

2. **"Create User Account" Button**:
```typescript
<Button onClick={() => setCreateUserDialogOpen(true)}>
  <UserPlus className="w-4 h-4 mr-2" />
  Create User Account
</Button>

<Dialog open={createUserDialogOpen}>
  <DialogTitle>Create User Account for {employee.full_name}</DialogTitle>
  <Form>
    <Input label="Email *" value={employee.email || ""} required />
    <Input label="Password *" type="password" required />
    
    <Alert type="info">
      Suggested roles for "{employee.position_name}":
      {suggestedRoles.map(role => <Badge key={role}>{role}</Badge>)}
    </Alert>
    
    <SmartSelect
      label="Role *"
      dataSource={roleDataSource}
      required
      context={{ suggestedFirst: true }}
    />
    
    <Button onClick={handleCreateUser}>Create User Account</Button>
  </Form>
</Dialog>
```

3. **Display Linked User** trong Employee Table:
```typescript
<TableCell>
  {employee.user_id ? (
    <Badge className="bg-blue-100 text-blue-800">
      <User className="w-3 h-3 mr-1" />
      {employee.user_email}
    </Badge>
  ) : (
    <span className="text-gray-400">No user</span>
  )}
</TableCell>
```

**Business Rules**:
- `user_id` is optional - employee kh√¥ng nh·∫•t thi·∫øt ph·∫£i c√≥ user account
- `user_id` must be unique - m·ªôt user ch·ªâ link v·ªõi m·ªôt employee
- Context filter `excludeLinkedUsers: true` - ch·ªâ show users ch∆∞a link
- Khi unlink user (set `user_id = null`), user account v·∫´n t·ªìn t·∫°i

---

### Requirement #5: Fix EmployeeManagement Schema Mismatch

**Changes Required**:

1. **Update Employee Interface**:
```typescript
// ‚ùå BEFORE
interface Employee {
  first_name: string;
  last_name: string;
}

// ‚úÖ AFTER
interface Employee {
  full_name: string;  // Match DB schema
  email?: string;     // NEW - optional
}
```

2. **Update Form UI**:
```typescript
// ‚ùå BEFORE
<Input label="First Name" id="first_name" />
<Input label="Last Name" id="last_name" />

// ‚úÖ AFTER
<Input 
  label="Full Name *" 
  id="full_name"
  placeholder="Nguy·ªÖn VƒÉn A"
  required
/>
<Input 
  label="Email (Optional)" 
  id="email"
  type="email"
  placeholder="employee@honda.com"
  helperText="Required if employee needs system access"
/>
```

3. **Remove Mock Data**:
```typescript
// ‚ùå DELETE (lines 73-99)
const departments = [...]
const positions = [...]
const levels = [...]
```

4. **Update Filters to SmartSelect**:
```typescript
// ‚úÖ Replace Select with SmartSelect
<SmartSelect
  dataSource={departmentDataSource}
  value={selectedDepartment}
  onChange={setSelectedDepartment}
  label="Department"
  placeholder="All Departments"
  allowClear={true}
/>
```

---

### Requirement #6: Fix WarehouseManagement Mock Managers

**Changes Required**:

1. **Remove mock data** (lines 56-63):
```typescript
// ‚ùå DELETE
const managers = [
  { id: "1", name: "Nguy·ªÖn VƒÉn A" },
  // ...
];
```

2. **Add SmartSelect DataSource**:
```typescript
const employeeDataSource: SelectDataSource = {
  search: async (req) => {
    const res = await fetch('/api/shared/search/employees', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ...req,
        context: {
          onlyActive: true,
          positionFilter: ["Manager", "Supervisor", "Director"]
        }
      })
    });
    return res.json();
  }
};
```

3. **Replace select v·ªõi SmartSelect** (lines 384-398):
```typescript
// ‚ùå BEFORE
<select
  value={formData.manager_id}
  onChange={(e) => setFormData({ ...formData, manager_id: e.target.value })}
  required
>
  <option value="">Ch·ªçn qu·∫£n l√Ω</option>
  {managers.map((manager) => (
    <option key={manager.id} value={manager.id}>{manager.name}</option>
  ))}
</select>

// ‚úÖ AFTER
<SmartSelect
  dataSource={employeeDataSource}
  value={formData.manager_id ? Number(formData.manager_id) : null}
  onChange={(id) => setFormData({ ...formData, manager_id: id ? String(id) : "" })}
  label="Qu·∫£n L√Ω *"
  placeholder="Ch·ªçn qu·∫£n l√Ω..."
  required
/>
```

---

### Requirement #7: SmartSelect Search Endpoints

**Endpoints to Create**:
1. `/api/shared/search/departments`
2. `/api/shared/search/positions`
3. `/api/shared/search/employee-levels`
4. `/api/shared/search/employees`
5. `/api/shared/search/users`

**Request Format**:
```typescript
POST /api/shared/search/departments
{
  "query": "sales",
  "limit": 20,
  "cursor": null,
  "context": {
    "onlyActive": true
  }
}
```

**Response Format**:
```typescript
{
  "items": [
    {
      "id": "dept_001",
      "label": "Sales Department",
      "subtitle": "DEPT-001 | 15 employees",
      "meta": {
        "id": "dept_001",
        "department_code": "DEPT-001",
        "department_name": "Sales Department",
        "description": "Sales and Marketing",
        "status": "ACTIVE"
      }
    }
  ],
  "nextCursor": "eyJpZCI6ImRlcHRfMDAxIn0="
}
```

**Search Fields by Entity**:
- **Departments**: `department_name`, `department_code`
- **Positions**: `position_name`, `position_code`
- **Levels**: `level_name`, `level_code`
- **Employees**: `full_name`, `employee_code`, `email`
- **Users**: `email`, `name`

**Context Filters**:
```typescript
// departments, positions, levels
context: {
  onlyActive: boolean  // Filter by status = ACTIVE
}

// employees
context: {
  onlyActive: boolean,           // Filter by status = ACTIVE
  positionFilter: string[]       // Filter by position names
}

// users
context: {
  onlyActive: boolean,           // Filter by status = ACTIVE
  excludeLinkedUsers: boolean    // Exclude users already linked to employees
}
```

---

## ‚úÖ VALIDATION RULES

### VR-001: Email Uniqueness for Users
```typescript
async function validateUserEmail(email: string, excludeUserId?: string) {
  const existing = await prisma.User.findUnique({ where: { email } });
  if (existing && existing.id !== excludeUserId) {
    throw new ValidationError("Email already used by another user");
  }
}
```

### VR-002: User-Employee Linking
```typescript
async function validateEmployeeUserLink(employeeId: string, userId: string) {
  // Check employee not already linked
  const employee = await prisma.employees.findUnique({ where: { id: employeeId } });
  if (employee.user_id && employee.user_id !== userId) {
    throw new ValidationError("Employee already linked to another user");
  }
  
  // Check user not already linked
  const user = await prisma.User.findUnique({ 
    where: { id: userId }, 
    include: { employees: true } 
  });
  if (user.employees && user.employees.id !== employeeId) {
    throw new ValidationError("User already linked to another employee");
  }
}
```

### VR-003: Role Assignment Validation
```typescript
async function validateRoleAssignment(roleId: string, employeeId: string) {
  const role = await prisma.Role.findUnique({ where: { id: roleId } });
  if (!role || role.status !== "ACTIVE") {
    throw new ValidationError("Invalid or inactive role");
  }
  
  // Warning if role doesn't match position
  const employee = await prisma.employees.findUnique({
    where: { id: employeeId },
    include: { master_positions: true }
  });
  
  const suggestedRoles = getRolesForPosition(employee.master_positions?.position_name);
  if (!suggestedRoles.includes(role.name)) {
    console.warn(`Role ${role.name} not typically assigned to position ${employee.master_positions?.position_name}`);
  }
}
```

### VR-004: Department/Position/Level Name Uniqueness
```typescript
async function validateMasterDataName(
  table: 'departments' | 'positions' | 'levels',
  name: string,
  excludeId?: string
) {
  const nameField = `${table.slice(0, -1)}_name`;
  const existing = await prisma[`master_${table}`].findFirst({
    where: { [nameField]: name }
  });
  
  if (existing && existing.id !== excludeId) {
    throw new ValidationError(`${table} name already exists`);
  }
}
```

### VR-005: Employee Full Name Required
```typescript
async function validateEmployeeData(data: CreateEmployeeDto) {
  if (!data.full_name || data.full_name.trim().length === 0) {
    throw new ValidationError("Full name is required");
  }
  
  if (data.full_name.length > 200) {
    throw new ValidationError("Full name must be less than 200 characters");
  }
}
```

### VR-006: Warehouse Manager Must Be Employee
```typescript
async function validateWarehouseManager(managerId: string) {
  const employee = await prisma.employees.findUnique({
    where: { id: managerId },
    include: { master_positions: true }
  });
  
  if (!employee) {
    throw new ValidationError("Manager must be a valid employee");
  }
  
  if (employee.status !== "ACTIVE") {
    throw new ValidationError("Manager must be an active employee");
  }
  
  // Optional: Check position
  const validPositions = ["Manager", "Supervisor", "Director"];
  if (!validPositions.includes(employee.master_positions?.position_name)) {
    console.warn(`Employee ${employee.full_name} position is ${employee.master_positions?.position_name}, not a typical manager position`);
  }
}
```

---

## üîß IMPLEMENTATION PLAN

### Phase 1: API Endpoints & Schema Changes (Week 1, Days 1-3)
**Owner**: Backend Team  
**Effort**: 3 days (24 hours)

| Task | Description | Effort |
|------|-------------|--------|
| 1.1 | Add `email` field to Employee model (migration) | 2h |
| 1.2 | Create `/api/shared/search/departments` endpoint | 2h |
| 1.3 | Create `/api/shared/search/positions` endpoint | 2h |
| 1.4 | Create `/api/shared/search/employee-levels` endpoint | 2h |
| 1.5 | Create `/api/shared/search/employees` endpoint | 3h |
| 1.6 | Create `/api/shared/search/users` endpoint | 3h |
| 1.7 | Add validation rules (VR-001 to VR-006) | 4h |
| 1.8 | Unit tests cho 5 search endpoints | 4h |
| 1.9 | Update User API to return computed department | 2h |

### Phase 2: UI Pages cho Master Tables (Week 1, Days 4-5 + Week 2, Days 1-2)
**Owner**: Frontend Team  
**Effort**: 4 days (32 hours)

| Task | Description | Effort |
|------|-------------|--------|
| 2.1 | Create `DepartmentManagement.tsx` component | 4h |
| 2.2 | Create `app/(main)/master-data/departments/page.tsx` | 1h |
| 2.3 | Create `PositionManagement.tsx` component | 4h |
| 2.4 | Create `app/(main)/master-data/positions/page.tsx` | 1h |
| 2.5 | Create `LevelManagement.tsx` component | 4h |
| 2.6 | Create `app/(main)/master-data/levels/page.tsx` | 1h |
| 2.7 | Add menu items cho 3 pages | 1h |
| 2.8 | Integration tests cho 3 pages | 4h |
| 2.9 | UAT cho master data CRUD | 4h |
| 2.10 | Bug fixes | 8h |

### Phase 3: Fix EmployeeManagement & WarehouseManagement (Week 2, Days 3-5)
**Owner**: Frontend + Backend Team  
**Effort**: 3 days (24 hours)

| Task | Description | Effort |
|------|-------------|--------|
| 3.1 | Fix schema mismatch (first_name/last_name ‚Üí full_name) | 3h |
| 3.2 | Add email field to Employee form | 1h |
| 3.3 | Add user_id field v·ªõi SmartSelect | 4h |
| 3.4 | Implement "Create User Account" dialog | 6h |
| 3.5 | Add smart role suggestions logic | 3h |
| 3.6 | Remove mock data from EmployeeManagement | 1h |
| 3.7 | Update filters to use SmartSelect | 3h |
| 3.8 | Add user linking display trong table | 2h |
| 3.9 | Fix WarehouseManagement mock managers | 2h |
| 3.10 | Test warehouse creation v·ªõi real employee IDs | 1h |

### Phase 4: Lifecycle Management & Testing (Week 3)
**Owner**: Full Team  
**Effort**: 5 days (40 hours)

| Task | Description | Effort |
|------|-------------|--------|
| 4.1 | Implement lifecycle warning system | 4h |
| 4.2 | Create admin dashboard widget | 3h |
| 4.3 | Unit tests cho validation rules | 4h |
| 4.4 | Integration tests cho Employee-User linking | 4h |
| 4.5 | E2E tests cho master data CRUD | 4h |
| 4.6 | Migration script cho employee emails | 2h |
| 4.7 | Data cleanup script cho fake warehouse manager IDs | 3h |
| 4.8 | UAT execution | 8h |
| 4.9 | Bug fixes v√† adjustments | 8h |

**Total Effort**: 17 developer-days (136 hours)

---

## ‚úÖ ACCEPTANCE CRITERIA

### API Endpoints
- [ ] 5 search endpoints created v√† tested (departments, positions, levels, employees, users)
- [ ] All endpoints return SmartSelect format
- [ ] Multi-field search works
- [ ] Cursor pagination works
- [ ] Context filtering (onlyActive, excludeLinkedUsers, positionFilter) works
- [ ] Response time < 200ms

### UI Pages
- [ ] 3 management pages accessible via menu (departments, positions, levels)
- [ ] CRUD operations work cho t·∫•t c·∫£ 3 pages
- [ ] Search v√† filters work
- [ ] Validation messages hi·ªÉn th·ªã correctly
- [ ] Auto-generated codes (DEPT-XXX, POS-XXX, LVL-XXX) work
- [ ] Employee count hi·ªÉn th·ªã correctly

### EmployeeManagement Fix
- [ ] Form c√≥ `full_name` field (required)
- [ ] Form c√≥ `email` field (optional)
- [ ] Form c√≥ `user_id` field (optional) v·ªõi SmartSelect
- [ ] KH√îNG C√íN `first_name`, `last_name` fields
- [ ] Create employee works v·ªõi full_name
- [ ] Link employee v·ªõi user works
- [ ] "Create User Account" dialog works
- [ ] Smart role suggestions hi·ªÉn th·ªã correctly
- [ ] Edit employee works
- [ ] SmartSelect dropdowns load real data (NO mock data)
- [ ] Filters work v·ªõi real data
- [ ] User linking display trong table
- [ ] No console errors

### WarehouseManagement Fix
- [ ] Manager dropdown uses SmartSelect
- [ ] Manager dropdown loads real employees
- [ ] Manager dropdown filters by position (Manager, Supervisor, Director)
- [ ] Warehouse creation saves real employee IDs
- [ ] Existing warehouses v·ªõi fake manager IDs ƒë∆∞·ª£c cleaned up
- [ ] Manager name hi·ªÉn th·ªã correctly trong warehouse table

### Data Integrity
- [ ] Existing employee data kh√¥ng b·ªã ·∫£nh h∆∞·ªüng
- [ ] Department/Position/Level codes auto-generated correctly
- [ ] Unique constraints enforced (employee_code, user_id, User.email)
- [ ] Soft delete works
- [ ] User linking validation works (prevent duplicate linking)
- [ ] Email validation works
- [ ] Warehouse manager validation works
- [ ] No orphan records

### Lifecycle Management
- [ ] Notification created khi employee terminated v·ªõi active user
- [ ] Admin dashboard widget shows pending reviews
- [ ] Deactivate user button works
- [ ] Keep active button works
- [ ] Scheduled task created (auto-deactivate after 7 days)
- [ ] Cancel scheduled task works

### Computed Fields
- [ ] User API returns computed `department` field
- [ ] Department value matches Employee.department_name
- [ ] User without Employee returns `department = null`

---

## üß™ TESTING STRATEGY

### Unit Tests
```typescript
// Test: Department search endpoint
describe('POST /api/shared/search/departments', () => {
  it('should return departments matching query', async () => {
    const response = await request(app)
      .post('/api/shared/search/departments')
      .send({ query: 'sales', limit: 10 });
    
    expect(response.status).toBe(200);
    expect(response.body.items).toHaveLength(1);
    expect(response.body.items[0].label).toContain('Sales');
  });
  
  it('should filter by onlyActive context', async () => {
    const response = await request(app)
      .post('/api/shared/search/departments')
      .send({ query: '', context: { onlyActive: true } });
    
    expect(response.body.items.every(item => item.meta.status === 'ACTIVE')).toBe(true);
  });
});

// Test: User-Employee linking validation
describe('validateEmployeeUserLink', () => {
  it('should throw error if employee already linked', async () => {
    await expect(
      validateEmployeeUserLink('emp_001', 'user_002')
    ).rejects.toThrow('Employee already linked to another user');
  });
});

// Test: Computed department field
describe('GET /api/users/:id', () => {
  it('should return computed department from employee', async () => {
    const response = await request(app).get('/api/users/user_001');
    
    expect(response.body.department).toBe('Sales Department');
    expect(response.body.department_id).toBe('dept_001');
  });
});

// Test: Warehouse manager validation
describe('validateWarehouseManager', () => {
  it('should throw error if manager is not employee', async () => {
    await expect(
      validateWarehouseManager('invalid_id')
    ).rejects.toThrow('Manager must be a valid employee');
  });
  
  it('should throw error if manager is inactive', async () => {
    await expect(
      validateWarehouseManager('inactive_emp_id')
    ).rejects.toThrow('Manager must be an active employee');
  });
});
```

### Integration Tests
```typescript
// Test: Create User for Employee flow
describe('Create User for Employee', () => {
  it('should create user and link to employee', async () => {
    const employee = await createTestEmployee({ email: 'test@honda.com' });
    
    const response = await request(app)
      .post('/api/employees/create-user')
      .send({
        employee_id: employee.id,
        email: 'test@honda.com',
        password: 'Test123!',
        role_id: 'role_001'
      });
    
    expect(response.status).toBe(201);
    expect(response.body.user.email).toBe('test@honda.com');
    
    const updatedEmployee = await prisma.employees.findUnique({
      where: { id: employee.id }
    });
    expect(updatedEmployee.user_id).toBe(response.body.user.id);
  });
});

// Test: Warehouse creation v·ªõi real manager
describe('Create Warehouse with Real Manager', () => {
  it('should create warehouse with employee manager', async () => {
    const manager = await createTestEmployee({ 
      full_name: 'Manager A',
      position_id: 'manager_position_id'
    });
    
    const response = await request(app)
      .post('/api/master/warehouses')
      .send({
        name: 'Test Warehouse',
        address: '123 Test St',
        manager_id: manager.id,
        capacity: 1000
      });
    
    expect(response.status).toBe(201);
    expect(response.body.data.manager_id).toBe(manager.id);
    
    // Verify manager name is populated
    const warehouse = await prisma.warehouses.findUnique({
      where: { id: response.body.data.id },
      include: { employees: true }
    });
    expect(warehouse.employees.full_name).toBe('Manager A');
  });
});
```

### Manual UAT
- [ ] Admin login ‚Üí Navigate to Master Data ‚Üí Departments
- [ ] Click "Add Department" ‚Üí Fill form ‚Üí Save ‚Üí Success
- [ ] Search "Sales" ‚Üí Results filter correctly
- [ ] Edit department ‚Üí Update name ‚Üí Save ‚Üí Success
- [ ] Delete department ‚Üí Confirm ‚Üí Status = INACTIVE
- [ ] Repeat for Positions v√† Levels
- [ ] Navigate to Employees ‚Üí Click "Add Employee"
- [ ] Fill full_name, email ‚Üí Select department/position/level ‚Üí Save ‚Üí Success
- [ ] Click "Create User Account" ‚Üí Fill form ‚Üí Select role ‚Üí Save ‚Üí Success
- [ ] Verify employee appears v·ªõi user badge
- [ ] Edit employee ‚Üí Change department ‚Üí Save ‚Üí Success
- [ ] Set employee status = TERMINATED
- [ ] Verify notification appears in admin dashboard
- [ ] Click "Deactivate User" ‚Üí Confirm ‚Üí User.status = INACTIVE
- [ ] Navigate to Warehouses ‚Üí Click "Add Warehouse"
- [ ] Select manager from SmartSelect (real employees) ‚Üí Save ‚Üí Success
- [ ] Verify warehouse manager name displays correctly

---

## ‚ö†Ô∏è RISK ASSESSMENT

| Risk | Severity | Probability | Mitigation |
|------|----------|-------------|------------|
| Breaking existing employee data | üî¥ HIGH | üü¢ LOW | No DB schema changes to existing fields, only additions |
| SmartSelect performance issues | üü° MEDIUM | üü° MEDIUM | Implement cursor pagination, add indexes on search fields |
| User confusion (full_name vs first/last) | üü° MEDIUM | üî¥ HIGH | Clear label "Full Name *", placeholder "Nguy·ªÖn VƒÉn A", training |
| User linking conflicts | üü° MEDIUM | üü° MEDIUM | Validation prevents duplicate linking, clear error messages |
| Missing validation | üü° MEDIUM | üü° MEDIUM | Comprehensive validation rules (VR-001 to VR-006) |
| Email field migration issues | üü° MEDIUM | üü¢ LOW | Migration script tested, rollback plan available |
| Lifecycle notification spam | üü¢ LOW | üü° MEDIUM | Batch notifications, configurable frequency |
| Role suggestion inaccuracy | üü¢ LOW | üü° MEDIUM | Admin has final decision, can override suggestions |
| Warehouse data integrity | üî¥ HIGH | üü° MEDIUM | Data cleanup script, validation on manager_id |
| Fake manager IDs in existing data | üî¥ HIGH | üî¥ HIGH | Migration script to clean up, manual review required |

---

## üì¶ DELIVERABLES

### Code Files to Create (16 files)
1. `app/api/shared/search/departments/route.ts`
2. `app/api/shared/search/positions/route.ts`
3. `app/api/shared/search/employee-levels/route.ts`
4. `app/api/shared/search/employees/route.ts`
5. `app/api/shared/search/users/route.ts`
6. `app/(main)/master-data/departments/page.tsx`
7. `app/(main)/master-data/positions/page.tsx`
8. `app/(main)/master-data/levels/page.tsx`
9. `components/master/DepartmentManagement.tsx`
10. `components/master/PositionManagement.tsx`
11. `components/master/LevelManagement.tsx`
12. `lib/validation/employee-user-linking.ts`
13. `lib/validation/warehouse-manager.ts`
14. `lib/events/employee-lifecycle.ts`
15. `prisma/migrations/YYYYMMDDHHMMSS_add_employee_email.sql`
16. `scripts/cleanup-warehouse-managers.ts`

### Code Files to Modify (5 files)
1. `components/master/EmployeeManagement.tsx` (fix schema mismatch, add user linking, remove mock data)
2. `components/master/WarehouseManagement.tsx` (replace mock managers v·ªõi SmartSelect)
3. `app/api/users/[id]/route.ts` (add computed department field)
4. `types/employee.types.ts` (update interfaces)
5. `app/(main)/layout.tsx` (add menu items)

### Documentation (5 docs)
1. API Documentation for 5 new search endpoints
2. User Guide: Managing Departments/Positions/Levels
3. User Guide: Linking Employees to Users
4. Admin Guide: Employee Lifecycle Management
5. Migration Guide: Employee Email Field & Warehouse Manager Cleanup

---

## üéØ SUCCESS METRICS

| Metric | Target | Measurement |
|--------|--------|-------------|
| API Response Time | < 200ms | Average response time for search endpoints |
| UI Load Time | < 1s | Time to load master data pages |
| Data Integrity | 100% | No orphan records, all constraints enforced, no fake IDs |
| User Adoption | 80% | % of admins using UI vs DB tools |
| Bug Rate | < 5 bugs | Critical bugs found in UAT |
| Test Coverage | > 80% | Unit + integration test coverage |
| Mock Data Removed | 100% | No hardcoded arrays in production components |

---

## üìÖ TIMELINE

**Start Date**: 2026-02-10  
**End Date**: 2026-02-28  
**Duration**: 3 weeks (17 developer-days)

**Milestones**:
- **Week 1 End**: API endpoints + schema changes + 3 master data pages complete
- **Week 2 End**: EmployeeManagement + WarehouseManagement fixes complete
- **Week 3 End**: Testing complete, UAT passed, ready for production

---

## üë• STAKEHOLDERS

| Role | Name | Responsibility |
|------|------|----------------|
| **Design Authority** | Antigravity | CR approval, architecture review |
| **Backend Lead** | TBD | API implementation, validation rules |
| **Frontend Lead** | TBD | UI pages, component development |
| **QA Lead** | TBD | Testing strategy, UAT execution |
| **Product Owner** | TBD | Requirements clarification, UAT approval |

---

## üìù NOTES

### Assumptions
- Database schema can be modified (add email field to employees)
- Notification system exists or will be implemented
- Scheduled task system exists or will be implemented (optional - can use simplified version)
- Admin users have necessary permissions
- Existing warehouse data v·ªõi fake manager IDs can be cleaned up

### Dependencies
- SmartSelect component (already exists)
- Prisma ORM
- Next.js API routes
- shadcn/ui components

### Out of Scope
- Other modules using AutocompleteFK (separate CR)
- Advanced features (bulk import/export for master tables)
- UI/UX redesign
- Mobile app support
- Notification system implementation (if doesn't exist)
- Scheduled task system implementation (if doesn't exist)

---

**Status**: DRAFT - Ready for Review  
**Next Steps**: 
1. Review by stakeholders
2. Approval by Design Authority
3. Resource allocation
4. Implementation kickoff

---

## üìä SUMMARY

**Total Gaps**: 6  
**Total Solutions**: 5 best practices  
**Total Endpoints**: 5 new search endpoints  
**Total Pages**: 3 new master data pages  
**Total Components**: 5 (3 new + 2 modified)  
**Total Validation Rules**: 6  
**Total Effort**: 17 developer-days (136 hours)  
**Total Deliverables**: 21 files (16 new + 5 modified)

**Key Improvements**:
- ‚úÖ FRD Compliance (FR-MD-005-02)
- ‚úÖ Data Integrity (no fake IDs, proper FK constraints)
- ‚úÖ Security (lifecycle management, user deactivation)
- ‚úÖ UX Consistency (SmartSelect everywhere, no mock data)
- ‚úÖ Scalability (future-proof design)
- ‚úÖ Maintainability (validation rules, computed fields)
