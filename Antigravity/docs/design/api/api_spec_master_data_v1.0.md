# API Specification: Master Data Management

## Document Information
- **Module**: Master Data Management
- **Version**: 1.0
- **Created**: 31/01/2026
- **Updated by**: CR-MD-001
- **Author**: Antigravity - API Architect
- **Project**: Honda SPICE ERP System

---

## ðŸ“‹ Má»¥c Lá»¥c

1. [Endpoints Overview](#1-endpoints-overview)
2. [Endpoint Details](#2-endpoint-details)
3. [Data Mapping](#3-data-mapping)
4. [Integration Points](#4-integration-points)
5. [Audit Logging](#5-audit-logging)

---

## 1. Endpoints Overview

| Method | Endpoint | Description | Added By | Breaking |
|--------|----------|-------------|----------|----------|
| GET | /api/vehicle-models | List all models | Existing | No |
| POST | /api/vehicle-models | Create model | Existing | No |
| PATCH | /api/vehicle-models/[id] | Update model | **CR-MD-001** | **No** |
| DELETE | /api/vehicle-models/[id] | Soft delete model | **CR-MD-001** | **No** |

**Breaking Change Analysis**:
- âœ… PATCH endpoint: NEW (not modifying existing)
- âœ… DELETE endpoint: NEW (not modifying existing)
- âœ… GET endpoint: NO CHANGES (backward compatible)
- âœ… POST endpoint: NO CHANGES (backward compatible)

---

## 2. Endpoint Details

### 2.1 GET /api/vehicle-models

**Status**: âœ… Existing (no changes)  
**Purpose**: Retrieve list of vehicle models with filtering, sorting, pagination

**Query Parameters**:

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `search` | string | No | - | Search by name or code (partial match) |
| `category` | string[] | No | - | Filter by category (SEDAN, SUV, HATCHBACK, MPV) |
| `status` | string | No | ACTIVE | Filter by status (ACTIVE, INACTIVE, ALL) |
| `min_price` | number | No | 0 | Minimum base price |
| `max_price` | number | No | - | Maximum base price |
| `page` | number | No | 1 | Page number (1-indexed) |
| `limit` | number | No | 20 | Items per page (max 100) |
| `sort` | string | No | created_at:desc | Sort field:direction |

**Request Example**:
```http
GET /api/vehicle-models?search=city&category=SEDAN&status=ACTIVE&page=1&limit=20&sort=model_name:asc
```

**Response**: 200 OK
```json
{
  "data": [
    {
      "id": 1,
      "model_code": "MOD/2026/001",
      "model_name": "Honda City RS",
      "category": "SEDAN",
      "base_price": 559000000.00,
      "status": "ACTIVE",
      "created_at": "2026-01-30T10:00:00Z",
      "updated_at": "2026-01-30T10:00:00Z",
      "deleted_at": null
    },
    {
      "id": 3,
      "model_code": "MOD/2026/003",
      "model_name": "Honda City Hatchback",
      "category": "HATCHBACK",
      "base_price": 549000000.00,
      "status": "ACTIVE",
      "created_at": "2026-01-30T10:05:00Z",
      "updated_at": "2026-01-30T10:05:00Z",
      "deleted_at": null
    }
  ],
  "meta": {
    "total": 2,
    "page": 1,
    "limit": 20,
    "total_pages": 1
  }
}
```

**Error Responses**:
- `400 Bad Request`: Invalid query parameters
- `401 Unauthorized`: Missing or invalid authentication token
- `403 Forbidden`: User lacks MASTER_DATA.READ permission

---

### 2.2 POST /api/vehicle-models

**Status**: âœ… Existing (no changes)  
**Purpose**: Create a new vehicle model

**Request Headers**:
```
Content-Type: application/json
Authorization: Bearer {token}
```

**Request Body**:
```json
{
  "model_name": "Honda City RS",
  "category": "SEDAN",
  "base_price": 559000000.00,
  "status": "ACTIVE"
}
```

**Field Validation**:
- `model_name`: Required, max 100 chars, unique (case-insensitive)
- `category`: Required, enum (SEDAN/SUV/HATCHBACK/MPV)
- `base_price`: Required, decimal(15,2), must be > 0
- `status`: Optional, enum (ACTIVE/INACTIVE), default ACTIVE
- `model_code`: NOT ALLOWED (auto-generated by system)

**Response**: 201 Created
```json
{
  "id": 1,
  "model_code": "MOD/2026/001",
  "model_name": "Honda City RS",
  "category": "SEDAN",
  "base_price": 559000000.00,
  "status": "ACTIVE",
  "created_at": "2026-01-30T10:00:00Z",
  "updated_at": "2026-01-30T10:00:00Z",
  "deleted_at": null
}
```

**Error Responses**:
- `400 Bad Request`: Validation failed
  ```json
  {
    "error": "Validation failed",
    "details": {
      "model_name": ["Model name is required"],
      "base_price": ["Price must be greater than 0"]
    }
  }
  ```
- `401 Unauthorized`: Missing or invalid token
- `403 Forbidden`: User lacks MASTER_DATA.CREATE permission
- `409 Conflict`: Duplicate model_name
  ```json
  {
    "error": "Conflict",
    "message": "Model name already exists"
  }
  ```

---

### 2.3 PATCH /api/vehicle-models/[id]

**Status**: âŒ NEW (added by CR-MD-001)  
**Breaking**: No (new endpoint)  
**Purpose**: Update an existing vehicle model

**Path Parameters**:
- `id` (number, required): VehicleModel ID

**Request Headers**:
```
Content-Type: application/json
Authorization: Bearer {token}
```

**Request Body** (all fields optional):
```json
{
  "model_name": "Honda City RS 2026",
  "category": "SEDAN",
  "base_price": 569000000.00,
  "status": "ACTIVE"
}
```

**Field Validation**:
- `model_code`: NOT ALLOWED (immutable field)
- `model_name`: Optional, max 100 chars, unique (case-insensitive)
- `category`: Optional, enum (SEDAN/SUV/HATCHBACK/MPV)
- `base_price`: Optional, decimal(15,2), must be > 0
- `status`: Optional, enum (ACTIVE/INACTIVE)

**Response**: 200 OK
```json
{
  "id": 1,
  "model_code": "MOD/2026/001",
  "model_name": "Honda City RS 2026",
  "category": "SEDAN",
  "base_price": 569000000.00,
  "status": "ACTIVE",
  "created_at": "2026-01-30T10:00:00Z",
  "updated_at": "2026-01-31T14:30:00Z",
  "deleted_at": null
}
```

**Error Responses**:
- `400 Bad Request`: Validation failed
  ```json
  {
    "error": "Validation failed",
    "details": {
      "model_code": ["Model code cannot be changed"],
      "base_price": ["Price must be greater than 0"]
    }
  }
  ```
- `401 Unauthorized`: Missing or invalid token
- `403 Forbidden`: User lacks MASTER_DATA.UPDATE permission
- `404 Not Found`: VehicleModel not found
  ```json
  {
    "error": "Not Found",
    "message": "VehicleModel with id 999 not found"
  }
  ```
- `409 Conflict`: Duplicate model_name
  ```json
  {
    "error": "Conflict",
    "message": "Model name already exists"
  }
  ```

---

### 2.4 DELETE /api/vehicle-models/[id]

**Status**: âŒ NEW (added by CR-MD-001)  
**Breaking**: No (new endpoint)  
**Purpose**: Soft delete a vehicle model (set status = INACTIVE)

**Path Parameters**:
- `id` (number, required): VehicleModel ID

**Request Headers**:
```
Authorization: Bearer {token}
```

**Action**: 
- SET `status` = 'INACTIVE'
- SET `deleted_at` = NOW()
- NOT hard delete (preserve record)

**Response**: 200 OK
```json
{
  "message": "VehicleModel deleted successfully",
  "id": 1
}
```

**Error Responses**:
- `401 Unauthorized`: Missing or invalid token
- `403 Forbidden`: User lacks MASTER_DATA.DELETE permission
- `404 Not Found`: VehicleModel not found
  ```json
  {
    "error": "Not Found",
    "message": "VehicleModel with id 999 not found"
  }
  ```

---

## 3. Data Mapping

### 3.1 UI â†’ API â†’ DB

| UI Field | API Field | DB Column | Validation |
|----------|-----------|-----------|------------|
| Model Code | `model_code` | `model_code` | Auto-generated, immutable |
| Model Name | `model_name` | `model_name` | Required, max 100, unique |
| Category | `category` | `category` | Required, enum |
| Base Price | `base_price` | `base_price` | Required, > 0 |
| Status | `status` | `status` | Enum, default ACTIVE |

### 3.2 DB â†’ API â†’ UI

| DB Column | API Field | UI Display |
|-----------|-----------|------------|
| `id` | `id` | Hidden (internal use) |
| `model_code` | `model_code` | MOD/001 (text, monospace) |
| `model_name` | `model_name` | Honda City RS (text) |
| `category` | `category` | SEDAN (badge, blue) |
| `base_price` | `base_price` | 559,000,000â‚« (currency format) |
| `status` | `status` | ACTIVE (badge, green) |
| `created_at` | `created_at` | 30/01/2026 10:00 (datetime) |
| `updated_at` | `updated_at` | 31/01/2026 14:30 (datetime) |
| `deleted_at` | `deleted_at` | Hidden (internal use) |

---

## 4. Integration Points

### 4.1 CRM Module

**Endpoint**: `GET /api/vehicle-models?status=ACTIVE`  
**Used by**: Lead form, `model_interest` dropdown  
**Purpose**: Populate dropdown with active models

**Request**:
```http
GET /api/vehicle-models?status=ACTIVE&sort=model_name:asc
```

**Response** (simplified):
```json
{
  "data": [
    {"id": 1, "model_name": "Honda City RS"},
    {"id": 2, "model_name": "Honda CR-V L"},
    {"id": 3, "model_name": "Honda Civic RS"}
  ]
}
```

**UI Implementation**:
```jsx
// Lead Form
<Select name="model_interest">
  {vehicleModels.map(model => (
    <Option key={model.id} value={model.model_name}>
      {model.model_name}
    </Option>
  ))}
</Select>
```

---

### 4.2 Sales Module

**Endpoint**: `GET /api/vehicle-models?status=ACTIVE`  
**Used by**: Quotation form, `vehicle_model_id` dropdown  
**Purpose**: Populate dropdown with active models and auto-fill base price

**Request**:
```http
GET /api/vehicle-models?status=ACTIVE&sort=model_name:asc
```

**Response**:
```json
{
  "data": [
    {
      "id": 1,
      "model_name": "Honda City RS",
      "base_price": 559000000.00
    },
    {
      "id": 2,
      "model_name": "Honda CR-V L",
      "base_price": 1029000000.00
    }
  ]
}
```

**UI Implementation**:
```jsx
// Quotation Form
<Select 
  name="vehicle_model_id"
  onChange={(value) => {
    const model = vehicleModels.find(m => m.id === value);
    form.setFieldValue('base_price', model.base_price);
  }}
>
  {vehicleModels.map(model => (
    <Option key={model.id} value={model.id}>
      {model.model_name} - {formatCurrency(model.base_price)}â‚«
    </Option>
  ))}
</Select>
```

---

### 4.3 Inventory Module

**Endpoint**: `GET /api/vehicle-models/[id]`  
**Used by**: Vehicle detail, display model info  
**Purpose**: Fetch model details for a specific vehicle

**Request**:
```http
GET /api/vehicle-models/1
```

**Response**:
```json
{
  "id": 1,
  "model_code": "MOD/2026/001",
  "model_name": "Honda City RS",
  "category": "SEDAN",
  "base_price": 559000000.00,
  "status": "ACTIVE"
}
```

**UI Implementation**:
```jsx
// Vehicle Detail Page
<div>
  <h2>{vehicle.vin}</h2>
  <p>Model: {vehicleModel.model_name}</p>
  <p>Category: {vehicleModel.category}</p>
  <p>Base Price: {formatCurrency(vehicleModel.base_price)}â‚«</p>
</div>
```

---

## 5. Audit Logging

**All CRUD operations** log to `activity_logs` table via middleware.

### 5.1 Log Structure

```json
{
  "user_id": 123,
  "action": "CREATE | UPDATE | DELETE | IMPORT | EXPORT",
  "entity": "VehicleModel",
  "entity_id": 1,
  "details": {
    "old_value": {...},
    "new_value": {...}
  },
  "ip_address": "192.168.1.100",
  "created_at": "2026-01-31T14:30:00Z"
}
```

### 5.2 Log Examples

**CREATE**:
```json
{
  "user_id": 123,
  "action": "CREATE",
  "entity": "VehicleModel",
  "entity_id": 1,
  "details": {
    "new_value": {
      "model_code": "MOD/2026/001",
      "model_name": "Honda City RS",
      "category": "SEDAN",
      "base_price": 559000000,
      "status": "ACTIVE"
    }
  },
  "ip_address": "192.168.1.100",
  "created_at": "2026-01-31T10:30:00Z"
}
```

**UPDATE**:
```json
{
  "user_id": 123,
  "action": "UPDATE",
  "entity": "VehicleModel",
  "entity_id": 1,
  "details": {
    "old_value": {"base_price": 559000000},
    "new_value": {"base_price": 569000000}
  },
  "ip_address": "192.168.1.100",
  "created_at": "2026-01-31T14:30:00Z"
}
```

**DELETE**:
```json
{
  "user_id": 123,
  "action": "DELETE",
  "entity": "VehicleModel",
  "entity_id": 1,
  "details": {
    "old_value": {
      "model_code": "MOD/2026/001",
      "model_name": "Honda City RS",
      "status": "ACTIVE"
    }
  },
  "ip_address": "192.168.1.100",
  "created_at": "2026-01-31T16:00:00Z"
}
```

---

## Change Log

### v1.0 (31/01/2026) - CR-MD-001
- Initial API Spec for Master Data Management
- Documented existing endpoints: GET, POST /api/vehicle-models
- **Added NEW endpoints**:
  * PATCH /api/vehicle-models/[id] (update model)
  * DELETE /api/vehicle-models/[id] (soft delete)
- Added Data Mapping (UI â†” API â†” DB)
- Added Integration Points (CRM, Sales, Inventory)
- Added Audit Logging specification
- **Breaking Changes**: NONE (all new endpoints are additions)

---

**End of Document**
