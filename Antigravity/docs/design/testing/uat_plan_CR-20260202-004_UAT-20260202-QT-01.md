# UAT Plan: CR-20260202-004 - Quotation Module Upgrade

**UAT ID**: UAT-20260202-QT-01  
**CR ID**: CR-20260202-004  
**Module**: Sales - Quotation  
**Version**: 1.0  
**Date**: 2026-02-02  
**Tester**: UAT Team  

---

## 1. Test Scope

### 1.1 Features to Test
- ‚úÖ Payment Tab (Installment Calculator)
- ‚úÖ Analysis Tab (Profit Margin, Commission Scenarios)
- ‚úÖ Notes Tab (Customer/Internal Notes)
- ‚úÖ Quotation List (Dashboard Stats, New Columns)
- ‚úÖ API Endpoints (calculate-installment, calculate-profit)

### 1.2 Out of Scope
- Existing Quotation features (Info Tab, Accessories Tab) - Already tested
- Other Sales modules (Contracts, Deposits, Test Drives)

---

## 2. Test Environment

- **URL**: http://localhost:3000
- **Database**: honda_dms_test
- **Test Data**: Sample quotations with various scenarios
- **Browser**: Chrome (latest)

---

## 3. Test Cases

### 3.1 Payment Tab - Installment Calculator

#### TC-QT-001: Display Payment Tab
**Objective**: Verify Payment tab is visible and accessible  
**Steps**:
1. Navigate to `/sales/quotations/new`
2. Fill in customer and vehicle info
3. Click on "Payment" tab

**Expected Result**:
- Payment tab displays
- Default payment method is "Cash"
- Bank dropdown is disabled when Cash is selected

**Priority**: HIGH

---

#### TC-QT-002: Calculate Installment (30% Prepayment, 36 months)
**Objective**: Verify PMT calculation with standard scenario  
**Test Data**:
- Total Price: 1,476,400,000 VND
- Prepayment: 30%
- Loan Term: 36 months
- Interest Rate: 8.5%

**Steps**:
1. Go to Payment tab
2. Select "Installment" payment method
3. Select bank: "VPBank"
4. Select prepayment: "30%"
5. Select loan term: "36 months"
6. Verify interest rate shows 8.5%

**Expected Result**:
- Loan Amount: 1,033,480,000 VND
- Monthly Payment: ~32,500,000 VND (¬±100,000)
- Total Interest: ~136,520,000 VND
- Payment schedule displays 36 rows

**Acceptance Criteria**:
- Monthly payment matches PMT formula: `P * (r * (1 + r)^n) / ((1 + r)^n - 1)`
- Schedule shows decreasing balance each month

**Priority**: CRITICAL

---

#### TC-QT-003: Calculate Installment (Different Scenarios)
**Objective**: Verify PMT calculation with various prepayment ratios  
**Test Scenarios**:

| Prepayment | Loan Term | Expected Monthly Payment |
|------------|-----------|--------------------------|
| 20% | 24 months | ~49,000,000 VND |
| 40% | 48 months | ~19,500,000 VND |
| 50% | 60 months | ~12,300,000 VND |

**Steps**: Same as TC-QT-002 with different values

**Expected Result**: Monthly payment updates correctly for each scenario

**Priority**: HIGH

---

### 3.2 Analysis Tab - Profit Margin

#### TC-QT-004: Display Profit Analysis
**Objective**: Verify Analysis tab shows profit breakdown  
**Steps**:
1. Go to Analysis tab
2. Observe profit cards

**Expected Result**:
- Gross Profit card displays
- Profit Margin card displays with percentage
- Standard Commission shows 40,000,000 VND
- Actual Commission is editable

**Priority**: HIGH

---

#### TC-QT-005: Profit Margin Color-Coding
**Objective**: Verify margin status colors  
**Test Scenarios**:

| Scenario | Profit Margin | Expected Color |
|----------|---------------|----------------|
| High profit | 18% | Green (GOOD) |
| Medium profit | 12% | Orange (MEDIUM) |
| Low profit | 7% | Yellow (LOW) |
| Critical | 3% | Red (CRITICAL) |
| Loss | -2% | Red (LOSS) |

**Steps**:
1. Create quotations with different pricing
2. Go to Analysis tab
3. Observe profit margin card color

**Expected Result**: Color matches margin threshold per FRD BR-SAL-019

**Priority**: CRITICAL

---

#### TC-QT-006: Commission Scenarios
**Objective**: Verify commission scenario buttons update profit  
**Steps**:
1. Go to Analysis tab
2. Click "30M" commission scenario button
3. Observe profit margin change
4. Click "50M" commission scenario button
5. Observe profit margin change again

**Expected Result**:
- Clicking "30M" increases profit margin (lower commission)
- Clicking "50M" decreases profit margin (higher commission)
- Profit margin recalculates instantly

**Priority**: HIGH

---

#### TC-QT-007: Revenue Breakdown Dialog
**Objective**: Verify revenue detail popup  
**Steps**:
1. Go to Analysis tab
2. Click on "Revenue" card
3. Observe dialog popup

**Expected Result**:
- Dialog shows detailed revenue breakdown
- Accessories section is collapsible
- Services section is collapsible
- Promotions section shows negative values
- Total Revenue matches sum

**Priority**: MEDIUM

---

#### TC-QT-008: Cost Breakdown Dialog
**Objective**: Verify cost detail popup  
**Steps**:
1. Go to Analysis tab
2. Click on "Cost" card
3. Observe dialog popup

**Expected Result**:
- Dialog shows detailed cost breakdown
- Manufacturer cost: 1,150,000,000 VND (CR-V)
- Accessory cost: 70% of retail
- Service cost: 50% of retail
- Operating cost: 25,000,000 VND
- Marketing cost: 15,000,000 VND
- Total Cost matches sum

**Priority**: MEDIUM

---

### 3.3 Notes Tab

#### TC-QT-009: Save Customer Notes
**Objective**: Verify customer notes are saved  
**Steps**:
1. Go to Notes tab
2. Enter customer notes: "Delivery on weekend"
3. Click Save
4. Reload quotation
5. Go to Notes tab

**Expected Result**:
- Customer notes persist after save
- Notes display correctly on reload

**Priority**: HIGH

---

#### TC-QT-010: Save Internal Notes
**Objective**: Verify internal notes are saved separately  
**Steps**:
1. Go to Notes tab
2. Enter internal notes: "VIP customer - priority service"
3. Click Save
4. Reload quotation
5. Go to Notes tab

**Expected Result**:
- Internal notes persist after save
- Internal notes are separate from customer notes

**Priority**: HIGH

---

### 3.4 Quotation List - Dashboard

#### TC-QT-011: Display Dashboard Stats
**Objective**: Verify dashboard cards show correct aggregations  
**Precondition**: Create 10 test quotations (3 DRAFT, 4 SENT, 3 APPROVED)

**Steps**:
1. Navigate to `/sales/quotations`
2. Observe dashboard cards

**Expected Result**:
- Total Quotes: 10
- Draft: 3
- Sent: 4
- Approved: 3
- Total Value: SUM of all quotation prices (in Billion VND)

**Priority**: CRITICAL

---

#### TC-QT-012: Display New Table Columns
**Objective**: Verify new columns in quotation table  
**Steps**:
1. Navigate to `/sales/quotations`
2. Observe table columns

**Expected Result**:
- "Discount" column displays
- "Final Price" column displays
- "Expiry Date" column displays
- All columns show correct data

**Priority**: HIGH

---

#### TC-QT-013: Action Icons
**Objective**: Verify action icons are clickable  
**Steps**:
1. Navigate to `/sales/quotations`
2. Hover over a quotation row
3. Click each action icon

**Expected Result**:
- View icon (üëÅÔ∏è) opens readonly view
- Edit icon (‚úèÔ∏è) opens edit form (only for DRAFT)
- VOIP icon (üìû) triggers call (if implemented)
- Email icon (üìß) opens email dialog
- PDF icon (üìÑ) downloads PDF
- Delete icon (üóëÔ∏è) shows confirmation (only for DRAFT)

**Priority**: MEDIUM

---

### 3.5 API Endpoints

#### TC-QT-014: Calculate Installment API
**Objective**: Verify installment calculation endpoint  
**Method**: POST  
**Endpoint**: `/api/sales/quotations/calculate-installment`  
**Request Body**:
```json
{
  "total_price": 1476400000,
  "prepayment_ratio": 0.3,
  "loan_term": 36,
  "interest_rate": 8.5
}
```

**Expected Response** (200 OK):
```json
{
  "loan_amount": 1033480000,
  "prepayment": 442920000,
  "monthly_payment": 32500000,
  "total_interest": 136520000,
  "total_payment": 1170000000,
  "schedule": [...]
}
```

**Priority**: CRITICAL

---

#### TC-QT-015: Calculate Profit API
**Objective**: Verify profit calculation endpoint  
**Method**: POST  
**Endpoint**: `/api/sales/quotations/calculate-profit`  
**Request Body**:
```json
{
  "total_revenue": 1476400000,
  "base_price": 1319000000,
  "accessories_total": 20000000,
  "services_total": 18000000,
  "promotions_value": -15000000,
  "discount": 0,
  "actual_commission": 40000000
}
```

**Expected Response** (200 OK):
```json
{
  "total_revenue": 1476400000,
  "total_cost": 1350000000,
  "gross_profit": 126400000,
  "profit_margin": 8.56,
  "margin_status": "MEDIUM",
  "cost_breakdown": {...}
}
```

**Priority**: CRITICAL

---

## 4. Test Execution Summary

| Test Case | Priority | Status | Notes |
|-----------|----------|--------|-------|
| TC-QT-001 | HIGH | ‚è≥ Pending | |
| TC-QT-002 | CRITICAL | ‚è≥ Pending | |
| TC-QT-003 | HIGH | ‚è≥ Pending | |
| TC-QT-004 | HIGH | ‚è≥ Pending | |
| TC-QT-005 | CRITICAL | ‚è≥ Pending | |
| TC-QT-006 | HIGH | ‚è≥ Pending | |
| TC-QT-007 | MEDIUM | ‚è≥ Pending | |
| TC-QT-008 | MEDIUM | ‚è≥ Pending | |
| TC-QT-009 | HIGH | ‚è≥ Pending | |
| TC-QT-010 | HIGH | ‚è≥ Pending | |
| TC-QT-011 | CRITICAL | ‚è≥ Pending | |
| TC-QT-012 | HIGH | ‚è≥ Pending | |
| TC-QT-013 | MEDIUM | ‚è≥ Pending | |
| TC-QT-014 | CRITICAL | ‚è≥ Pending | |
| TC-QT-015 | CRITICAL | ‚è≥ Pending | |

**Total Test Cases**: 15  
**Critical**: 5  
**High**: 7  
**Medium**: 3  

---

## 5. Acceptance Criteria

UAT is considered PASSED if:
- ‚úÖ All CRITICAL test cases pass
- ‚úÖ At least 90% of HIGH priority test cases pass
- ‚úÖ No blocking bugs found
- ‚úÖ PMT calculations match formula (¬±0.1% tolerance)
- ‚úÖ Profit margin color-coding works correctly
- ‚úÖ Notes save and persist correctly
- ‚úÖ Dashboard stats are accurate

---

## 6. Test Data Requirements

### Sample Quotations:
1. **High Profit Quote**: Base price 1,319,000,000, minimal accessories, high margin
2. **Medium Profit Quote**: Base price 1,319,000,000, moderate accessories, medium margin
3. **Low Profit Quote**: Base price 1,319,000,000, many accessories, low margin
4. **Loss Quote**: Base price 1,319,000,000, heavy discounts, negative margin

### Sample Customers:
- Customer A: Standard customer
- Customer B: VIP customer (for notes testing)

---

## 7. Bug Reporting

**Bug Severity Levels**:
- **Critical**: Feature completely broken, blocks testing
- **High**: Major functionality issue, workaround exists
- **Medium**: Minor functionality issue, cosmetic
- **Low**: Typo, minor UI issue

**Bug Report Template**:
```
Bug ID: BUG-QT-XXX
Test Case: TC-QT-XXX
Severity: [Critical/High/Medium/Low]
Description: [What went wrong]
Steps to Reproduce: [Detailed steps]
Expected: [What should happen]
Actual: [What actually happened]
Screenshot: [If applicable]
```

---

**UAT Plan Prepared By**: Antigravity Authority  
**Review Status**: Ready for Execution  
**Next Step**: Execute UAT and document results in UAT Execution Log
